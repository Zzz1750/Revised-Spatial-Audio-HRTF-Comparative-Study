<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Object A</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
        body{
            margin: 0;
            background-color: black;
            color: white;
        }
        #start_scene1{
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            padding: 10px 20px;
            z-index: 100;
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            cursor: pointer;
        }
    </style>
</head>
<body>  


    <div id="intro_page" style="display: block;">
        <button id="start_scene1">Click</button>
    </div>

    <a-scene id="scene" vr-mode-ui="enabled: false" xr-mode-ui="enabled: false" visible="false">    
    <!-- scene1 -->
    <a-entity id="scene1" visible="false" light="defaultLightsEnabled: false">
        
        <a-plane id="object_plane" class="ray-target" width="2" height="4" position="-11 2.5 -6" rotation="0 80 0" color="green" material="opacity: 0.4; shader: flat; transparent: true"> </a-plane>
        <a-plane id="object_dummy_plane" class="ray-target" width="2" height="4" position="-11 2.5 5" rotation="0 120 0" color="red" material="opacity: 0.4; shader: flat; transparent: true"> </a-plane>
       
        <!--Object Text -->
        <a-text id="object1_text" 
            value="" 
            position="-5 3.5 -3" 
            align="center" 
            rotation="0 90 0"
            color="yellow">
        </a-text>

        <!--Object Dummy Text -->
        <a-text id="object1_dummy_text" 
                value=" " 
                position="-5 3.5 2.5" 
                align="center" 
                rotation="0 90 0"
                color="yellow">
            </a-text>

         <!--Reaction Text -->
        <a-text id="object1_reaction_text" 
                value="" 
                position="-5 3.5 0" 
                align="center" 
                rotation="0 90 0"
                color="yellow">
            </a-text>
        
        <a-text id="washout_delay_text" 
                value="Redirecting..." 
                position="-5 4.5 0" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                visible="false">
            </a-text>
        
        <!-- stereo reaction text -->
         <a-text id="stereo_reaction_text" 
                value="Stereo Reaction: " 
                position="-5 6 3" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- stereo nav text -->
         <a-text id="stereo_nav_text" 
                value="Stereo Nav: " 
                position="-5 5.6 3" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- stereo gaze text -->
         <a-text id="stereo_gaze_text" 
                value="Stereo Gaze: " 
                position="-5 5.2 3" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

         <!-- hrtf1 reaction text -->
         <a-text id="hrtf1_reaction_text" 
                value="HRTF 1 Reaction: " 
                position="-5 6 1" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- hrtf1 nav text -->
         <a-text id="hrtf1_nav_text" 
                value="HRTF 1 Nav: " 
                position="-5 5.6 1" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- hrtf1 gaze text -->
         <a-text id="hrtf1_gaze_text" 
                value="HRTF 1 Gaze: " 
                position="-5 5.2 1" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- hrtf2 reaction text -->
         <a-text id="hrtf2_reaction_text" 
                value="HRTF 2 Reaction: " 
                position="-5 6 -1" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- hrtf2 nav text -->
         <a-text id="hrtf2_nav_text" 
                value="HRTF 2 Nav: " 
                position="-5 5.6 -1" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- hrtf2 gaze text -->
         <a-text id="hrtf2_gaze_text" 
                value="HRTF 2 Gaze: " 
                position="-5 5.2 -1" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>



        <!-- binaural reaction text -->
         <a-text id="binaural_reaction_text" 
                value="Binaural Reaction: " 
                position="-5 6 -3" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- binaural nav text -->
         <a-text id="binaural_nav_text" 
                value="Binaural Nav: " 
                position="-5 5.6 -3" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- binaural gaze text -->
         <a-text id="binaural_gaze_text" 
                value="Binaural Gaze: " 
                position="-5 5.2 -3" 
                align="center" 
                rotation="0 90 0"
                color="yellow"
                width="4">
            </a-text>

        <!-- button 1 -->
        <a-entity id="button1" position="-4 3 0" rotation="0 90 0" visible="false">
            <a-plane id="button_plane1" color="white" width="" height="0" opacity="0.8" transparent="true" material="shader: flat" class="clickable"></a-plane>
            <a-text id="button_text1" value="Audio 1" align="center" color="black" position="0 0 0.01" width="3"></a-text>
        </a-entity>


         <a-entity id="look_panel" position="-5 4 0" rotation="0 90 0" visible="false">
            <a-plane id="look_panel_plane" color="white" width="0" height="0" opacity="0.8" transparent="true" material="shader: flat" class="clickable"></a-plane>
            <a-text id="look_panel_text" value="Look Here \n \n Click to Continue" width="5" align="center" color="black" position="0 0.2 0.01" width="3"></a-text>
        </a-entity>
    </a-entity>

        <!-- Washout Scene -->
         <a-entity id="washout_scene" visible="false" light="defaultLightsEnabled: false">
           <a-text id="washout_text1" value="Washout Period" position="-3 3.5 0" align="center" color="yellow" width="4" rotation="0 90 0"></a-text>
            <a-text id="countdownText" value="" position="-3 3.2 0" align="center" color="yellow" width="4" rotation="0 90 0"></a-text>
         </a-entity>

        <!-- sky sphere -->
        <a-sphere 
            id="sky"
            radius="50"
            material="side: back; src: ./images/check2.jpg; shader: flat; repeat: -1 1"
            rotation="0 180 0"
            position="0 0 0">
        </a-sphere>


        <!-- Camera rig with height and rotation -->
        <a-entity id="camera-rig" position="0 1.6 0" rotation="0 90 0">
            <a-camera id="camera" fov="90" position="0 0 0">
                <a-cursor
                    id="cursor"
                    raycaster="objects: .ray-target, .clickable"
                    fuse="false"
                    fuse-timeout="1500"
                    geometry="primitive: ring; radiusInner: 0.008; radiusOuter: 0.01"
                    material="color: #FFFFFF; shader: flat; opacity: 0"
                    animation__click="property: scale; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150; startEvents: click"
                    animation__fusing="property: scale; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500; startEvents: fusing">
                </a-cursor>
            </a-camera>

        <!-- Right controller -->
        <a-entity 
            laser-controls="hand: right" 
            raycaster="objects: .clickable" 
            cursor="fuse: false">
        </a-entity>

        <!-- Left controller -->
        <a-entity 
            laser-controls="hand: left" 
            raycaster="objects: .clickable" 
            cursor="fuse: false">
        </a-entity>
    </a-entity>

       <!-- Audio Section -->
        <a-entity id="stereo_audio" sound="src: ../audio/object1_stereo.wav; autoplay: false; positional: false"></a-entity>
        <a-entity id="hrtf1_audio" sound="src: ../audio/object1_hrtf1.wav; autoplay: false; positional: false"></a-entity>
        <a-entity id="hrtf2_audio" sound="src: ../audio/object1_hrtf2.wav; autoplay: false; positional: false"></a-entity>
        <a-entity id="binaural_audio" sound="src: ../audio/object1_binaural.wav; autoplay: false" position="-10.65944 0.49953 -6.22973"></a-entity>

    </a-scene>

    <script>

        const sky = document.getElementById('sky');
        const scene = document.querySelector("a-scene");
        const object1_text = document.getElementById('object1_text');
        const object_plane = document.getElementById('object_plane');
        const object_dummy_plane = document.getElementById('object_dummy_plane');
        const object1_dummy_text = document.getElementById('object1_dummy_text');  
        const object1_reaction_text = document.getElementById('object1_reaction_text');     
        const button1 = document.getElementById('button1');
        const button_plane1 = document.getElementById('button_plane1');
        const button_text1 = document.getElementById('button_text1');

        const stereo_audio = document.getElementById('stereo_audio');
        const hrtf1_audio = document.getElementById('hrtf1_audio');
        const hrtf2_audio = document.getElementById('hrtf2_audio');
        const binaural_audio = document.getElementById('binaural_audio');

        const look_panel = document.getElementById('look_panel');
        const look_panel_plane = document.getElementById('look_panel_plane');
        const look_panel_text = document.getElementById('look_panel_text');
        const washout_delay_text = document.getElementById('washout_delay_text');

        var main_controller = 1;
        var scene_controller = 1;
        //database values
        var stereo_reaction_time = 0;
        var stereo_nav_result = 0;
        var stereo_total_gaze = 0;

        var hrtf1_reaction_time = 0;
        var hrtf1_nav_result = 0;
        var hrtf1_total_gaze = 0;

        var hrtf2_reaction_time = 0;
        var hrtf2_nav_result = 0;
        var hrtf2_total_gaze = 0;

        var binaural_reaction_time = 0;
        var binaural_nav_result = 0;
        var binaural_total_gaze = 0;

        //a-scene setups
        function scene1(){
            sky.setAttribute('material', 'src', './images/check2.jpg');
            document.getElementById('scene1').setAttribute('visible','true');
            document.getElementById('washout_scene').setAttribute('visible','false');
            
            object1_dummy_text.setAttribute('value','');
            object1_reaction_text.setAttribute('value', '')
            object1_text.setAttribute('value','')
            document.getElementById('countdownText').setAttribute('value','')
        }

        function washout(){
            sky.setAttribute('material', 'src', './images/stierberg_sunrise_2k.png'); 
            document.getElementById('scene1').setAttribute('visible','false');
            document.getElementById('washout_scene').setAttribute('visible','true');  
            scene_controller = 0; 
            startCountdown('countdownText');     
        }
        document.getElementById('start_scene1').addEventListener('click',()=>{
            document.getElementById('intro_page').style.display='none';
            scene.setAttribute('visible','true');
            if (scene) {
                scene.enterVR();
                scene1();
            }
        });
        

        //Navigation Error System
        function check_dummy_wins(target_plane, dummy_plane, dummy_time) {
        return new Promise((resolve) => {
            let finished = false;

            function handleHover(buttonType) {
            if (!finished) {
                finished = true;
                if (buttonType === 'target') {
                resolve('Success'); 
                } 
                else {
                resolve('Fail'); 
                }
            }
            }

            target_plane.addEventListener('mouseenter', () => handleHover('target'), { once: true });
            dummy_plane.addEventListener('mouseenter', () => handleHover('dummy'), { once: true });

            setTimeout(() => {
            if (!finished) {
                finished = true;
                resolve('Failed to Look');
            }
            }, dummy_time);
        });
        }
        
        //Gaze Time System
        const gazeData = {
            object1: { time: 0 },
        };

        let startTime = null;

        function gaze_calculator_enter() {
            startTime = Date.now();
        }

        function gaze_calculator_exit(dataObj, property, textEl) {
            if (startTime) {
            const duration = Date.now() - startTime;
            dataObj[property] += duration;
            startTime = null;
            textEl.setAttribute('value', `Time: ${(dataObj[property] / 1000).toFixed(3)}s`);
            }
        }

        object_plane.addEventListener('mouseenter', () => {
            gaze_calculator_enter();
        });
        object_plane.addEventListener('mouseleave', () => {
            gaze_calculator_exit(gazeData.object1, 'time', object1_text);
        });


        //Reaction Time Calculator
        function check_reaction_time(spc_time, planeEl, callback) {
        let reaction_object = 0;
        let reacted = false;

        let reaction_watch = setInterval(() => {
            reaction_object++;
        }, 1000);

        planeEl.addEventListener('mouseenter', () => {
            if (!reacted) {
            reacted = true;
            clearInterval(reaction_watch);
            callback(reaction_object);
            }
        });

        setTimeout(() => {
            if (!reacted) {
            reacted = true;
            clearInterval(reaction_watch);
            callback('NULL');
            }
        }, spc_time);
        }

        look_panel.addEventListener('mouseenter',()=>{
            button1_returner();
        })

        button1.addEventListener('click', ()=>{
            Player();
            button_plane1.setAttribute('width','0');
            button_plane1.setAttribute('height','0');
            button1.setAttribute('visible','false')
        })

        function button1_returner(){
            look_panel_plane.setAttribute('color','green');
            setTimeout(()=>{
                look_panel.setAttribute('visible','false');
                look_panel_plane.setAttribute('width','0');
                look_panel_plane.setAttribute('height','0');
            },1000);
            setTimeout(()=>{
                look_panel_plane.setAttribute('color','white');
                button_plane1.setAttribute('width','1');
                button_plane1.setAttribute('height','0.3');
                button1.setAttribute('visible','true')
            },2000);
        }

        function look_panel_returner(){
            look_panel.setAttribute('visible','true');
            look_panel_plane.setAttribute('width','2');
            look_panel_plane.setAttribute('height','3');
        }

        setTimeout(()=>{
            look_panel_returner();
        },4000)


        function call_washout(){
            setTimeout(()=>{
                washout();
                washout_delay_text.setAttribute('visible','false');
            },2000);
        }
        function Player(){
            if(scene_controller == 1){
                switch (main_controller) {
                case 1:
                    console.log("audio 1 - stereo");
                    gazeData.object1.time=0;
                    stereo_audio.components.sound.playSound();

                    check_dummy_wins(object_plane, object_dummy_plane, 51000).then(result => {
                        stereo_nav_result = result;
                        object1_dummy_text.setAttribute('value', `Stereo Nav: ${stereo_nav_result}`);
                    });
                    
                    check_reaction_time(51000, object_plane, (time) => {
                        stereo_reaction_time = time;
                        object1_reaction_text.setAttribute('value', `Stereo Reaction: ${stereo_reaction_time}s`);
                    });

                    setTimeout(()=>{
                        stereo_total_gaze = gazeData.object1.time;
                        document.getElementById('stereo_gaze_text').setAttribute('value',`Stereo Gaze: ${stereo_total_gaze}`);
                        document.getElementById('stereo_nav_text').setAttribute('value',`Stereo Nav: ${stereo_nav_result}`);
                        document.getElementById('stereo_reaction_text').setAttribute('value',`Stereo Reaction: ${stereo_reaction_time}`);
                        washout_delay_text.setAttribute('visible','true');
                        button_text1.setAttribute('value','audio2');
                        call_washout();
                    },51000);
                    break;
                
                case 2:
                    console.log("audio 2 - hrtf 1");
                    gazeData.object1.time=0;
                    hrtf1_audio.components.sound.playSound();

                    check_dummy_wins(object_plane, object_dummy_plane, 51000).then(result => {
                        hrtf1_nav_result = result;
                        object1_dummy_text.setAttribute('value', `HRTF1 Nav: ${hrtf1_nav_result}`);
                    });
                    
                    check_reaction_time(51000, object_plane, (time) => {
                        hrtf1_reaction_time = time;
                        object1_reaction_text.setAttribute('value', `HRTF1 Reaction: ${hrtf1_reaction_time}s`);
                    });

                    setTimeout(()=>{
                        hrtf1_total_gaze = gazeData.object1.time;
                        document.getElementById('hrtf1_gaze_text').setAttribute('value',`HRTF1 Gaze: ${hrtf1_total_gaze}`);
                        document.getElementById('hrtf1_nav_text').setAttribute('value',`HRTF1 Nav: ${hrtf1_nav_result}`);
                        document.getElementById('hrtf1_reaction_text').setAttribute('value',`HRTF1 Reaction: ${hrtf1_reaction_time}`);
                        washout_delay_text.setAttribute('visible','true');
                        button_text1.setAttribute('value','audio 3');
                        call_washout();
                    },51000);
                    break;
                case 3:
                    console.log("audio 3 - hrtf 2");
                    gazeData.object1.time=0;
                    hrtf2_audio.components.sound.playSound();

                    check_dummy_wins(object_plane, object_dummy_plane, 51000).then(result => {
                        hrtf2_nav_result = result;
                        object1_dummy_text.setAttribute('value', `HRTF 2 Nav: ${hrtf2_nav_result}`);
                    });
                    
                    check_reaction_time(51000, object_plane, (time) => {
                        hrtf2_reaction_time = time;
                        object1_reaction_text.setAttribute('value', `HRTF 2 Reaction: ${hrtf2_reaction_time}s`);
                    });

                    setTimeout(()=>{
                        hrtf2_total_gaze = gazeData.object1.time;
                        document.getElementById('hrtf2_gaze_text').setAttribute('value',`HRTF2 Gaze: ${hrtf2_total_gaze}`);
                        document.getElementById('hrtf2_nav_text').setAttribute('value',`HRTF2 Nav: ${hrtf2_nav_result}`);
                        document.getElementById('hrtf2_reaction_text').setAttribute('value',`HRTF2 Reaction: ${hrtf2_reaction_time}`);
                        washout_delay_text.setAttribute('visible','true');
                        button_text1.setAttribute('value','audio 4');
                        call_washout();
                    },51000);
                    break;
                case 4:
                    console.log("audio 4 - binaural");
                    gazeData.object1.time=0;
                    binaural_audio.components.sound.playSound();

                    check_dummy_wins(object_plane, object_dummy_plane, 51000).then(result => {
                        binaural_nav_result = result;
                        object1_dummy_text.setAttribute('value', `Binaural Nav: ${binaural_nav_result}`);
                    });
                    
                    check_reaction_time(51000, object_plane, (time) => {
                        binaural_reaction_time = time;
                        object1_reaction_text.setAttribute('value', `Binaural Reaction: ${binaural_reaction_time}s`);
                    });

                    setTimeout(()=>{
                        binaural_total_gaze = gazeData.object1.time;
                        document.getElementById('binaural_gaze_text').setAttribute('value',`Binaural Gaze: ${binaural_total_gaze}`);
                        document.getElementById('binaural_nav_text').setAttribute('value',`Binaural Nav: ${binaural_nav_result}`);
                        document.getElementById('binaural_reaction_text').setAttribute('value',`Binaural Reaction: ${binaural_reaction_time}`);
                        washout_delay_text.setAttribute('visible','true');
                        button_text1.setAttribute('value','audio 4');
                    },51000);
                    break;
            }
            main_controller++;
            }
            
        }

    </script>

    <script>
    let timer;

    function startCountdown(elementId, startValue = 20, onFinish = () => console.log("Hello World")) {
        const textEl = document.querySelector(`#${elementId}`);
        if (!textEl) {
        console.error(`Element with id "${elementId}" not found.`);
        return;
        }

        clearInterval(timer);
        let count = startValue;

        timer = setInterval(() => {
        textEl.setAttribute('value', count);
        if (count === 0) {
            clearInterval(timer);
            scene1();
            look_panel_returner();
            scene_controller = 1;
        } else {
            count--;
        }
        }, 1000);
    }
    </script>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>VR Gun Controllers with Raycast</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^3.0.3/dist/aframe-event-set-component.min.js"></script>
</head>
<body>
    <a-scene 
        vr-mode-ui="enabled: true" 
        background="color: #222222"
        device-orientation-permission-ui="enabled: false">
        
        <!-- Left Controller with Gun -->
        <a-entity id="leftController" laser-controls="hand: left">
            <!-- Gun Model - Replace with your local model -->
            <a-entity 
                class="gun"
                gltf-model="#gunModel"
                scale="0.1 0.1 0.1"
                position="0.1 -0.1 -0.2"
                rotation="0 -90 90">
                
                <!-- Raycast Visual -->
                <a-entity 
                    class="raycast"
                    raycaster="objects: .target; showLine: true"
                    line="color: red; opacity: 0.8"
                    visible="false">
                </a-entity>
                
                <!-- Muzzle Flash -->
                <a-entity 
                    class="muzzle-flash"
                    geometry="primitive: plane"
                    material="color: yellow; transparent: true; opacity: 0"
                    scale="0.1 0.1 0.1"
                    position="0 0.5 -1"
                    visible="false">
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- Right Controller with Gun -->
        <a-entity id="rightController" laser-controls="hand: right">
            <!-- Gun Model - Replace with your local model -->
            <a-entity 
                class="gun"
                gltf-model="#gunModel"
                scale="0.1 0.1 0.1"
                position="-0.1 -0.1 -0.2"
                rotation="0 90 -90">
                
                <!-- Raycast Visual -->
                <a-entity 
                    class="raycast"
                    raycaster="objects: .target; showLine: true"
                    line="color: red; opacity: 0.8"
                    visible="false">
                </a-entity>
                
                <!-- Muzzle Flash -->
                <a-entity 
                    class="muzzle-flash"
                    geometry="primitive: plane"
                    material="color: yellow; transparent: true; opacity: 0"
                    scale="0.1 0.1 0.1"
                    position="0 0.5 -1"
                    visible="false">
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- Gun Model Asset - REPLACE THIS WITH YOUR LOCAL MODEL PATH -->
        <a-assets>
            <a-asset-item id="gunModel" src="gun.glb"></a-asset-item>
        </a-assets>

        <!-- Targets -->
        <a-entity id="targets">
            <a-box 
                class="target"
                position="0 1.5 -3"
                width="1" height="1" depth="0.1"
                color="#4CC3D9"
                data-health="3">
            </a-box>
            
            <a-sphere 
                class="target"
                position="2 1.5 -4"
                radius="0.5"
                color="#EF2D5E"
                data-health="2">
            </a-sphere>
            
            <a-cylinder 
                class="target"
                position="-2 1.5 -4"
                radius="0.5" height="1"
                color="#FFC65D"
                data-health="1">
            </a-cylinder>
        </a-entity>

        <!-- Environment -->
        <a-plane 
            position="0 0 -4" 
            rotation="-90 0 0" 
            width="10" 
            height="10" 
            color="#7BC8A4">
        </a-plane>

        <a-sky color="#87CEEB"></a-sky>

        <!-- Lighting -->
        <a-entity light="type: ambient; color: #BBB"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>
    </a-scene>

    <script>
        // Custom component for gun behavior
        AFRAME.registerComponent('gun-controller', {
            init: function() {
                this.raycaster = this.el.querySelector('.raycast');
                this.muzzleFlash = this.el.querySelector('.muzzle-flash');
                this.isShooting = false;
                
                // Trigger down event
                this.el.addEventListener('triggerdown', () => {
                    this.shoot();
                });
                
                // Trigger up event
                this.el.addEventListener('triggerup', () => {
                    this.stopShooting();
                });
            },
            
            shoot: function() {
                this.isShooting = true;
                
                // Show raycast line
                this.raycaster.setAttribute('visible', 'true');
                
                // Show muzzle flash
                this.muzzleFlash.setAttribute('visible', 'true');
                this.muzzleFlash.setAttribute('material', 'opacity', 1);
                
                // Perform raycast
                this.raycaster.components.raycaster.refreshObjects();
                const intersections = this.raycaster.components.raycaster.intersections;
                
                if (intersections.length > 0) {
                    const target = intersections[0].object.el;
                    if (target.classList.contains('target')) {
                        this.hitTarget(target);
                    }
                }
                
                // Hide muzzle flash after delay
                setTimeout(() => {
                    this.muzzleFlash.setAttribute('material', 'opacity', 0);
                }, 100);
            },
            
            stopShooting: function() {
                this.isShooting = false;
                this.raycaster.setAttribute('visible', 'false');
            },
            
            hitTarget: function(target) {
                // Get current health
                let health = parseInt(target.getAttribute('data-health')) || 1;
                health--;
                
                if (health <= 0) {
                    // Target destroyed
                    target.parentNode.removeChild(target);
                    
                    // Create explosion effect
                    this.createExplosion(target.object3D.position);
                } else {
                    // Update health and change color based on health
                    target.setAttribute('data-health', health);
                    
                    // Flash effect
                    const originalColor = target.getAttribute('material').color;
                    target.setAttribute('material', 'color', '#FFFFFF');
                    
                    setTimeout(() => {
                        const colors = ['#4CC3D9', '#EF2D5E', '#FFC65D'];
                        target.setAttribute('material', 'color', colors[health - 1] || '#FF0000');
                    }, 100);
                }
            },
            
            createExplosion: function(position) {
                const explosion = document.createElement('a-entity');
                explosion.setAttribute('position', position);
                explosion.setAttribute('particle-system', {
                    preset: 'default',
                    color: '#FF9500, #FF4D00',
                    particleCount: 30,
                    velocityValue: '2 2 2',
                    accelerationValue: '0 -3 0'
                });
                
                this.el.sceneEl.appendChild(explosion);
                
                // Remove explosion after 1 second
                setTimeout(() => {
                    this.el.sceneEl.removeChild(explosion);
                }, 1000);
            }
        });

        // Add gun controller component to both guns
        document.querySelectorAll('.gun').forEach(gun => {
            gun.setAttribute('gun-controller', '');
        });

        // Add teleport controls for movement
        AFRAME.registerComponent('teleport-controls', {
            init: function() {
                this.teleportCursor = null;
                this.isTeleporting = false;
                
                // Create teleport cursor
                this.teleportCursor = document.createElement('a-entity');
                this.teleportCursor.setAttribute('geometry', 'primitive: ring; radiusInner: 0.8; radiusOuter: 1;');
                this.teleportCursor.setAttribute('material', 'color: white; shader: flat;');
                this.teleportCursor.setAttribute('position', '0 0.1 0');
                this.teleportCursor.setAttribute('visible', 'false');
                this.el.appendChild(this.teleportCursor);
                
                // Trackpad events for teleportation
                this.el.addEventListener('trackpaddown', (evt) => {
                    this.startTeleport();
                });
                
                this.el.addEventListener('trackpadup', (evt) => {
                    if (this.isTeleporting) {
                        this.teleport();
                    }
                });
            },
            
            startTeleport: function() {
                this.isTeleporting = true;
                this.teleportCursor.setAttribute('visible', 'true');
            },
            
            teleport: function() {
                this.isTeleporting = false;
                this.teleportCursor.setAttribute('visible', 'false');
                
                const cursorPos = this.teleportCursor.object3D.position;
                const worldPos = new THREE.Vector3();
                this.teleportCursor.object3D.getWorldPosition(worldPos);
                
                // Teleport the camera rig
                const cameraRig = document.querySelector('[camera]').parentEl;
                cameraRig.setAttribute('position', {
                    x: worldPos.x,
                    y: 0,
                    z: worldPos.z
                });
            }
        });

        // Add teleport controls to controllers
        document.querySelectorAll('[laser-controls]').forEach(controller => {
            controller.setAttribute('teleport-controls', '');
        });
    </script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        
        /* Hide the default laser controls cursor */
        .a-entity [laser-controls] [cursor] {
            display: none;
        }
    </style>
</body>
</html>